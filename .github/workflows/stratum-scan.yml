name: 'Stratum AI Security Scan'
description: 'Scan AI agent projects for security risks, post PR comments, and optionally auto-fix'

inputs:
  fail-on:
    description: 'Fail threshold: "none", "high", "critical", or a numeric score'
    default: 'none'
  auto-fix:
    description: 'Generate auto-fix PR for fixable findings'
    default: 'false'
  upload:
    description: 'Upload profile to Stratum dashboard'
    default: 'true'
  stratum-token:
    description: 'Stratum API token for profile upload'
    default: ''
  python-version:
    description: 'Python version to use'
    default: '3.11'

runs:
  using: 'composite'
  steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}

    - name: Install Stratum
      run: pip install stratum-cli
      shell: bash

    - name: Run Stratum scan
      id: scan
      run: |
        stratum scan . --json > /tmp/stratum-result.json 2>/dev/null
        stratum scan . --quiet > /tmp/stratum-summary.txt 2>/dev/null
        SCORE=$(python3 -c "import json; print(json.load(open('/tmp/stratum-result.json'))['risk_score'])")
        FINDINGS=$(python3 -c "import json; r=json.load(open('/tmp/stratum-result.json')); print(len(r.get('top_paths',[])) + len(r.get('signals',[])))")
        echo "score=$SCORE" >> $GITHUB_OUTPUT
        echo "findings=$FINDINGS" >> $GITHUB_OUTPUT
      shell: bash

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('/tmp/stratum-summary.txt', 'utf8');
          const score = '${{ steps.scan.outputs.score }}';
          const findings = '${{ steps.scan.outputs.findings }}';

          // Delete previous Stratum comments
          const comments = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          for (const comment of comments.data) {
            if (comment.body.includes('Stratum AI Security Scan')) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id,
              });
            }
          }

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## üîç Stratum AI Security Scan\n\n**Risk Score: ${score}/100** ¬∑ ${findings} findings\n\n\`\`\`\n${summary}\n\`\`\`\n\n<sub>Powered by [Stratum](https://stratum.dev)</sub>`
          });

    - name: Generate auto-fix PR
      if: inputs.auto-fix == 'true'
      run: |
        stratum scan . --patch-output /tmp/stratum-fix.patch 2>/dev/null
        if [ -s /tmp/stratum-fix.patch ]; then
          git apply /tmp/stratum-fix.patch
          echo "fixes_applied=true" >> $GITHUB_OUTPUT
        else
          echo "fixes_applied=false" >> $GITHUB_OUTPUT
        fi
      shell: bash
      id: autofix

    - name: Create fix PR
      if: inputs.auto-fix == 'true' && steps.autofix.outputs.fixes_applied == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        commit-message: 'fix: apply Stratum security auto-fixes'
        title: 'Stratum: Auto-fix agent security findings'
        body: |
          ## Auto-generated security fixes

          Stratum identified fixable security findings and generated this PR.

          **Changes:**
          - Added `human_input=True` to tasks with outbound/destructive tools
          - Added `interrupt_before` to LangGraph compile() calls
          - Added `timeout=30` to HTTP calls without timeouts
          - Added `memory=True` to Crew() constructors

          Review each change carefully before merging.

          ---
          *Generated by [Stratum](https://stratum.dev)*
        branch: stratum/auto-fix
        delete-branch: true

    - name: Upload profile
      if: inputs.upload == 'true' && inputs.stratum-token != ''
      run: |
        python3 -c "
        import json, urllib.request
        r = json.load(open('/tmp/stratum-result.json'))
        p = r.get('telemetry_profile', {})
        p['project_name'] = '${{ github.event.repository.name }}'
        p['repo_url'] = 'https://github.com/${{ github.repository }}'
        p['org_id'] = '${{ github.repository_owner }}'
        p['branch'] = '${{ github.ref_name }}'
        p['commit_sha'] = '${{ github.sha }}'[:12]
        p['scan_source'] = 'github_action'
        req = urllib.request.Request(
            'https://api.stratum.dev/v1/profiles',
            data=json.dumps(p).encode(),
            headers={
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ${{ inputs.stratum-token }}',
            },
            method='POST',
        )
        try:
            urllib.request.urlopen(req, timeout=10)
            print('Profile uploaded successfully')
        except Exception as e:
            print(f'Upload failed (non-blocking): {e}')
        "
      shell: bash

    - name: Check fail threshold
      if: inputs.fail-on != 'none'
      run: |
        SCORE=${{ steps.scan.outputs.score }}
        THRESHOLD="${{ inputs.fail-on }}"

        if [ "$THRESHOLD" = "critical" ]; then
          python3 -c "
        import json
        r = json.load(open('/tmp/stratum-result.json'))
        findings = r.get('top_paths', []) + r.get('signals', [])
        if any(f.get('severity', '') == 'CRITICAL' for f in findings):
            exit(1)
        " || exit 1
        elif [ "$THRESHOLD" = "high" ]; then
          python3 -c "
        import json
        r = json.load(open('/tmp/stratum-result.json'))
        findings = r.get('top_paths', []) + r.get('signals', [])
        if any(f.get('severity', '') in ('CRITICAL', 'HIGH') for f in findings):
            exit(1)
        " || exit 1
        else
          # Numeric threshold
          if [ "$SCORE" -gt "$THRESHOLD" ]; then
            echo "Risk score $SCORE exceeds threshold $THRESHOLD"
            exit 1
          fi
        fi
      shell: bash
